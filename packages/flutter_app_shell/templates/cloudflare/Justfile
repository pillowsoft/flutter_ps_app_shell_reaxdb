# Edit worker paths if you move things
set dotenv-load := true

WORKER_DART_DIR := "workers/dart-api-worker"
WORKER_TS_DIR   := "workers/ts-auth-shim"

default: help

help:
	@echo "Tasks:"
	@echo "  just setup                     # wrangler login, install deps"
	@echo "  just secrets                   # set shared secrets (interactive)"
	@echo "  just dev-dart                  # build + wrangler dev (Dart worker)"
	@echo "  just build-dart                # compile Dart -> JS"
	@echo "  just deploy-dart               # deploy Dart worker"
	@echo "  just dev-shim                  # wrangler dev (TS auth shim)"
	@echo "  just deploy-shim               # deploy TS shim"
	@echo "  just r2-create BUCKET=...      # create R2 bucket"
	@echo "  just tail-dart                 # tail logs"
	@echo "  just tail-shim                 # tail logs"

setup:
	cd {{WORKER_TS_DIR}} && npm i || true
	wrangler login

secrets:
	cd {{WORKER_TS_DIR}} && wrangler secret put SESSION_JWT_SECRET
	cd {{WORKER_TS_DIR}} && wrangler secret put INSTANT_APP_ID
	cd {{WORKER_DART_DIR}} && wrangler secret put SESSION_JWT_SECRET
	cd {{WORKER_DART_DIR}} && wrangler secret put R2_ACCOUNT_ID
	cd {{WORKER_DART_DIR}} && wrangler secret put R2_ACCESS_KEY_ID
	cd {{WORKER_DART_DIR}} && wrangler secret put R2_SECRET_ACCESS_KEY
	cd {{WORKER_DART_DIR}} && wrangler secret put R2_BUCKET
	cd {{WORKER_DART_DIR}} && wrangler secret put CF_API_TOKEN

dev-dart:
	cd {{WORKER_DART_DIR}} && dart compile js -O4 -o build/worker.js lib/main.dart
	cd {{WORKER_DART_DIR}} && wrangler dev

build-dart:
	cd {{WORKER_DART_DIR}} && dart compile js -O4 -o build/worker.js lib/main.dart

deploy-dart: build-dart
	cd {{WORKER_DART_DIR}} && wrangler deploy

dev-shim:
	cd {{WORKER_TS_DIR}} && wrangler dev

deploy-shim:
	cd {{WORKER_TS_DIR}} && wrangler deploy

r2-create BUCKET:
	wrangler r2 bucket create {{BUCKET}}

tail-dart:
	cd {{WORKER_DART_DIR}} && wrangler tail

tail-shim:
	cd {{WORKER_TS_DIR}} && wrangler tail
